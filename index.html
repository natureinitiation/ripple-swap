<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>XRP ↔ USDC • Live AMM</title>
<script src="https://unpkg.com/xrpl@latest"></script>
<style>
  body{background:#0d1117;color:#c9d1d9;font-family:system-ui;margin:0}
  .card{max-width:520px;margin:30px auto;background:#161b22;border-radius:16px;overflow:hidden;box-shadow:0 10px 40px #0008}
  header{background:linear-gradient(135deg,#0066ff,#00d4ff);padding:30px;text-align:center;color:#fff}
  h1{font-size:28px;font-weight:800;margin:0}
  .tvl{font-size:48px;font-weight:900;margin:10px 0}
  main{padding:30px}
  .btn{display:block;width:100%;padding:16px;margin:15px 0;background:#238636;color:#fff;font-size:18px;font-weight:bold;border:none;border-radius:12px;cursor:pointer}
  .btn:hover{background:#2ea043}
  #qr{text-align:center;margin:20px 0}
  #log{background:#0d1117;padding:15px;border-radius:8px;max-height:200px;overflow:auto;font-family:monospace;font-size:14px;white-space:pre-wrap}
</style>
</head>
<body>
<div class="card">
  <header>
    <h1>XRP ↔ USDC</h1>
    <div class="tvl" id="tvl">…</div>
    <div>Live AMM • XRPL Mainnet</div>
  </header>
  <main>
    <button class="btn" id="connect">Connect Wallet (Xaman or any wallet)</button>
    <div id="qr" style="display:none"></div>

    <div id="actions" style="display:none">
      <input type="number" id="amount" placeholder="Amount XRP" value="100" style="width:100%;padding:14px;margin:15px 0;border-radius:8px;border:1px solid #30363d;background:#0d1117;color:#fff">
      <button class="btn" onclick="swap()">Swap XRP → USDC</button>
      <button class="btn" onclick="swapBack()">Swap USDC → XRP</button>
      <button class="btn" style="background:#8b949e" onclick="claimFees()">Claim Fees</button>
    </div>

    <div style="padding:20px;text-align:center;font-size:15px">
      Работает в любом браузере + внутри Xaman<br>
      Никаких серверов — чистый XRPL
    </div>
    <pre id="log">Waiting…</pre>
  </main>
</div>

<script>
const client = new xrpl.Client("wss://xrplcluster.com")
let wallet = null

const POOL = {
  currency1: "XRP",
  currency2: { currency: "USDC", issuer: "rhWBcX9NR9N8iU2n8tT1e9tQbZ4Z4Z4Z4" }
}

async function updateTVL() {
  try {
    const info = await client.request({command: "amm_info", asset: POOL.currency1, asset2: POOL.currency2})
    const tvl = (Number(info.result.amount)/1e6 + Number(info.result.amount2.value)).toFixed(1)
    document.getElementById("tvl").textContent = "$" + tvl + "M"
  } catch(e) { document.getElementById("tvl").textContent = "loading…" }
}
setInterval(updateTVL, 20000); updateTVL()

document.getElementById("connect").onclick = async () => {
  await client.connect()
  
  // Попробуем Xaman
  if (window.xaman) {
    const resp = await window.xaman.signIn()
    wallet = resp.wallet
  } 
  // Иначе — универсальный QR
  else {
    const payload = await client.request({
      command: "account_info",
      account: "rHb9CJAWyB4rj91VRWn96DkukG4bwdtyTh", // любой адрес, просто для генерации QR
      ledger_index: "validated"
    })
    const qr = `xumm:xumm.sign?account=${payload.result.account_data.Account}`
    document.getElementById("qr").innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qr)}" style="border-radius:12px">`
    document.getElementById("qr").style.display = "block"
    log("Отсканируй QR в Xaman")
    return
  }

  if (wallet) {
    document.getElementById("connect").textContent = "Connected " + wallet.address.slice(0,10)+"…"
    document.getElementById("actions").style.display = "block"
    log("Подключено")
  }
}

function log(t) {
  document.getElementById("log").textContent = new Date().toLocaleTimeString() + " → " + t + "\n" + document.getElementById("log").textContent
}

// Остальные функции swap/swapBack/claimFees оставляем как были раньше
async function swap() {
  const amount = document.getElementById("amount").value * 1e6 + ""
  const tx = await client.submitAndWait({
    TransactionType: "Payment",
    Account: wallet.address,
    Amount: amount,
    Destination: wallet.address,
    DeliverMin: { currency: "USDC", issuer: POOL.currency2.issuer, value: (document.getElementById("amount").value * 2.18).toFixed(2) },
    Flags: 2149249116
  }, { wallet })
  log("Swap OK → " + tx.hash)
}

async function swapBack() { alert("Скоро добавлю") }
async function claimFees() {
  const tx = await client.submitAndWait({
    TransactionType: "AMMWithdraw",
    Account: wallet.address,
    Asset: POOL.currency1,
    Asset2: POOL.currency2,
    Flags: 0x00020000
  }, { wallet })
  log("Fees claimed → " + tx.hash)
}
</script>
</body>
</html>